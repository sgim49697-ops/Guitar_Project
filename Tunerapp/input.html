<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê¸°íƒ€ íŠœë„ˆ - ì…ë ¥ (iPhone)</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #1a1a2e;
    color: #eee;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
  }
  .container {
    text-align: center;
    width: 400px;
    max-width: 95vw;
  }
  h1 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: #8888cc;
  }
  .subtitle {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 1.5rem;
  }

  #startBtn {
    padding: 14px 40px;
    font-size: 1.1rem;
    background: #4a4a8a;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 1rem;
  }
  #startBtn:hover { background: #5a5a9a; }
  #startBtn.active { background: #44cc66; }

  .status {
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }
  .status.connected {
    background: #2a4a2a;
    color: #44cc66;
  }
  .status.disconnected {
    background: #4a2a2a;
    color: #cc4444;
  }

  .preview {
    background: #2a2a4a;
    border-radius: 8px;
    padding: 20px;
    margin-top: 1rem;
  }
  .preview .note {
    font-size: 3rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }
  .preview .freq {
    font-size: 1rem;
    color: #888;
  }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ¸ ê¸°íƒ€ íŠœë„ˆ ì…ë ¥</h1>
  <div class="subtitle">iPhone ë§ˆì´í¬ ì‚¬ìš©</div>

  <div class="status disconnected" id="status">ì„œë²„ ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

  <button id="startBtn" onclick="toggleTuner()">ë§ˆì´í¬ ì‹œì‘</button>

  <div class="preview">
    <div class="note" id="noteName">-</div>
    <div class="freq" id="freqDisplay">-- Hz</div>
  </div>
</div>

<script>
// WebSocket ì—°ê²°
let ws = null;
let wsReconnectTimer = null;

function connectWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const host = window.location.host;
  ws = new WebSocket(`${protocol}//${host}`);

  ws.onopen = () => {
    console.log('WebSocket ì—°ê²°ë¨');
    document.getElementById('status').textContent = 'âœ“ ì„œë²„ ì—°ê²°ë¨';
    document.getElementById('status').className = 'status connected';

    // ì…ë ¥ í´ë¼ì´ì–¸íŠ¸ë¡œ ë“±ë¡
    ws.send(JSON.stringify({ type: 'register', role: 'input' }));
  };

  ws.onclose = () => {
    console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
    document.getElementById('status').textContent = 'âœ— ì„œë²„ ì—°ê²° ëŠê¹€ - ì¬ì—°ê²° ì‹œë„ ì¤‘...';
    document.getElementById('status').className = 'status disconnected';

    // 3ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„
    wsReconnectTimer = setTimeout(connectWebSocket, 3000);
  };

  ws.onerror = (error) => {
    console.error('WebSocket ì˜¤ë¥˜:', error);
  };
}

connectWebSocket();

// ê¸°íƒ€ íŠœë‹ ì‹œìŠ¤í…œ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
const GUITAR_STRINGS = [
  { num: 6, note: 'E2', freq: 82.41 },
  { num: 5, note: 'A2', freq: 110.00 },
  { num: 4, note: 'D3', freq: 146.83 },
  { num: 3, note: 'G3', freq: 196.00 },
  { num: 2, note: 'B3', freq: 246.94 },
  { num: 1, note: 'E4', freq: 329.63 },
];

const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

let audioCtx = null;
let analyser = null;
let stream = null;
let isRunning = false;
let animFrameId = null;

async function toggleTuner() {
  const btn = document.getElementById('startBtn');
  if (isRunning) {
    stopTuner();
    btn.textContent = 'ë§ˆì´í¬ ì‹œì‘';
    btn.classList.remove('active');
    return;
  }
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 4096;
    source.connect(analyser);

    isRunning = true;
    btn.textContent = 'ë…¹ìŒ ì¤‘...';
    btn.classList.add('active');
    detect();
  } catch (e) {
    alert('ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
  }
}

function stopTuner() {
  isRunning = false;
  if (animFrameId) cancelAnimationFrame(animFrameId);
  if (stream) stream.getTracks().forEach(t => t.stop());
  if (audioCtx) audioCtx.close();
  audioCtx = null;
  document.getElementById('noteName').textContent = '-';
  document.getElementById('freqDisplay').textContent = '-- Hz';
}

function autoCorrelate(buf, sampleRate) {
  let rms = 0;
  for (let i = 0; i < buf.length; i++) rms += buf[i] * buf[i];
  rms = Math.sqrt(rms / buf.length);
  if (rms < 0.01) return -1;

  let r1 = 0, r2 = buf.length - 1;
  const threshold = 0.2;
  for (let i = 0; i < buf.length / 2; i++) {
    if (Math.abs(buf[i]) < threshold) { r1 = i; } else break;
  }
  for (let i = buf.length - 1; i >= buf.length / 2; i--) {
    if (Math.abs(buf[i]) < threshold) { r2 = i; } else break;
  }

  const trimmed = buf.slice(r1, r2);
  const len = trimmed.length;

  const c = new Float32Array(len);
  for (let i = 0; i < len; i++) {
    for (let j = 0; j < len - i; j++) {
      c[i] += trimmed[j] * trimmed[j + i];
    }
  }

  let d = 0;
  while (c[d] > c[d + 1]) d++;

  let maxVal = -1, maxPos = -1;
  for (let i = d; i < len; i++) {
    if (c[i] > maxVal) { maxVal = c[i]; maxPos = i; }
  }

  const t0 = maxPos > 0 ? c[maxPos - 1] : c[maxPos];
  const t1 = c[maxPos];
  const t2 = maxPos < len - 1 ? c[maxPos + 1] : c[maxPos];
  const a = (t0 + t2 - 2 * t1) / 2;
  const b = (t2 - t0) / 2;
  const betterPos = a ? maxPos - b / (2 * a) : maxPos;

  return sampleRate / betterPos;
}

function freqToNote(freq) {
  const semitone = 12 * Math.log2(freq / 440);
  const midi = Math.round(semitone) + 69;
  const name = NOTE_NAMES[midi % 12];
  const octave = Math.floor(midi / 12) - 1;
  const exactFreq = 440 * Math.pow(2, (midi - 69) / 12);
  const cents = 1200 * Math.log2(freq / exactFreq);
  return { name, octave, midi, exactFreq, cents };
}

function findClosestString(freq) {
  let minDist = Infinity, closest = 0;
  GUITAR_STRINGS.forEach((s, i) => {
    const dist = Math.abs(1200 * Math.log2(freq / s.freq));
    if (dist < minDist) { minDist = dist; closest = i; }
  });
  return closest;
}

function detect() {
  if (!isRunning) return;
  animFrameId = requestAnimationFrame(detect);

  const buf = new Float32Array(analyser.fftSize);
  analyser.getFloatTimeDomainData(buf);

  const freq = autoCorrelate(buf, audioCtx.sampleRate);
  if (freq === -1) return;

  const noteInfo = freqToNote(freq);
  const targetIdx = findClosestString(freq);
  const target = GUITAR_STRINGS[targetIdx];
  const centsFromTarget = 1200 * Math.log2(freq / target.freq);

  // ë¡œì»¬ í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
  document.getElementById('noteName').textContent = noteInfo.name + noteInfo.octave;
  document.getElementById('freqDisplay').textContent = freq.toFixed(1) + ' Hz';

  // WebSocketìœ¼ë¡œ ë°ì´í„° ì „ì†¡
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: 'tuning',
      freq: freq,
      note: noteInfo.name + noteInfo.octave,
      cents: centsFromTarget,
      targetNote: target.note,
      targetIdx: targetIdx
    }));
  }
}
</script>
</body>
</html>
