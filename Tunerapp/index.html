<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guitar Tuner</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #1a1a2e;
    color: #eee;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  .container {
    text-align: center;
    width: 400px;
    max-width: 95vw;
  }
  h1 {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    color: #8888cc;
  }

  /* 시작 버튼 */
  #startBtn {
    padding: 14px 40px;
    font-size: 1.1rem;
    background: #4a4a8a;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 1.5rem;
  }
  #startBtn:hover { background: #5a5a9a; }
  #startBtn.active { background: #cc4444; }

  /* 줄 선택 */
  .strings {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 2rem;
  }
  .strings button {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    border: 2px solid #555;
    background: #2a2a4a;
    color: #ccc;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .strings button.active {
    border-color: #6a6aff;
    background: #3a3a6a;
    color: #fff;
  }
  .strings button .note { font-weight: bold; font-size: 1rem; }
  .strings button .num { font-size: 0.7rem; opacity: 0.6; }

  /* 감지된 음 */
  .detected {
    margin-bottom: 1.5rem;
  }
  .detected .note {
    font-size: 4rem;
    font-weight: bold;
    line-height: 1;
  }
  .detected .freq {
    font-size: 1rem;
    color: #888;
    margin-top: 4px;
  }

  /* 튜닝 미터 */
  .meter {
    position: relative;
    height: 40px;
    background: #2a2a4a;
    border-radius: 20px;
    margin-bottom: 1rem;
    overflow: hidden;
  }
  .meter .center-line {
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #666;
    transform: translateX(-50%);
  }
  .meter .indicator {
    position: absolute;
    top: 50%;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #cc4444;
    transform: translate(-50%, -50%);
    transition: left 0.1s, background 0.2s;
    left: 50%;
  }
  .meter .indicator.in-tune { background: #44cc66; }

  /* 센트 표시 */
  .cents {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
  }
  .cents.sharp { color: #cc6644; }
  .cents.flat { color: #4488cc; }
  .cents.in-tune { color: #44cc66; }

  /* 가이드 메시지 */
  .guide {
    font-size: 1.1rem;
    min-height: 1.5em;
    color: #aaa;
  }

  .idle-msg {
    color: #666;
    margin-top: 1rem;
  }

  /* 디버그 패널 */
  .debug-panel {
    margin-top: 1rem;
    padding: 8px 12px;
    background: #111;
    border-radius: 8px;
    font-size: 0.8rem;
    color: #888;
    text-align: left;
    font-family: monospace;
  }
  .debug-panel span { color: #0ff; }
</style>
</head>
<body>
<div class="container">
  <h1>Guitar Tuner</h1>

  <button id="startBtn" onclick="toggleTuner()">마이크 시작</button>

  <div class="strings" id="strings"></div>

  <div class="detected">
    <div class="note" id="noteName">-</div>
    <div class="freq" id="freqDisplay">-- Hz</div>
  </div>

  <div class="meter">
    <div class="center-line"></div>
    <div class="indicator" id="indicator"></div>
  </div>

  <div class="cents" id="centsDisplay">0 cents</div>
  <div class="guide" id="guide">마이크를 시작하고 기타를 연주하세요</div>

  <!-- 디버그 패널: 실제 RMS 값 확인용 -->
  <div class="debug-panel" id="debugPanel" style="display:none">
    RMS: <span id="rmsVal">-</span> &nbsp;|&nbsp;
    임계값: <span id="threshVal">0.003</span> &nbsp;|&nbsp;
    감지: <span id="detectVal">-</span>
  </div>
</div>

<script>
// 기타 표준 튜닝 (6번→1번 줄)
const GUITAR_STRINGS = [
  { num: 6, note: 'E2', freq: 82.41 },
  { num: 5, note: 'A2', freq: 110.00 },
  { num: 4, note: 'D3', freq: 146.83 },
  { num: 3, note: 'G3', freq: 196.00 },
  { num: 2, note: 'B3', freq: 246.94 },
  { num: 1, note: 'E4', freq: 329.63 },
];

// 크로매틱 스케일 (전체 음이름 매핑용)
const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

let audioCtx = null;
let analyser = null;
let stream = null;
let isRunning = false;
let selectedString = null;
let animFrameId = null;

// 줄 선택 버튼 생성
const stringsEl = document.getElementById('strings');
GUITAR_STRINGS.forEach((s, i) => {
  const btn = document.createElement('button');
  btn.innerHTML = `<div class="note">${s.note.replace(/\d/, '')}</div><div class="num">${s.num}번</div>`;
  btn.onclick = () => selectString(i);
  stringsEl.appendChild(btn);
});

function selectString(idx) {
  selectedString = idx;
  document.querySelectorAll('.strings button').forEach((btn, i) => {
    btn.classList.toggle('active', i === idx);
  });
}

// 기본: 자동 감지 (선택 없음)
selectString(null);

async function toggleTuner() {
  const btn = document.getElementById('startBtn');
  if (isRunning) {
    stopTuner();
    btn.textContent = '마이크 시작';
    btn.classList.remove('active');
    return;
  }
  try {
    // iOS에서 노이즈 제거 기능들이 기타 소리를 잡음으로 처리하므로 모두 끔
    stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: false,
        noiseSuppression: false,
        autoGainControl: false,
        channelCount: 1,
      }
    });
    // iOS Safari 호환성 (webkitAudioContext 폴백)
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // iOS는 터치 후에도 AudioContext가 suspended 상태일 수 있음
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 8192; // 낮은 음(6번줄 E2=82Hz) 감지 정밀도 향상
    analyser.smoothingTimeConstant = 0.5; // 변동 완화
    source.connect(analyser);

    isRunning = true;
    btn.textContent = '정지';
    btn.classList.add('active');
    document.getElementById('debugPanel').style.display = 'block';
    detect();
  } catch (e) {
    document.getElementById('guide').textContent = '마이크 접근이 거부되었습니다';
  }
}

function stopTuner() {
  isRunning = false;
  if (animFrameId) cancelAnimationFrame(animFrameId);
  if (stream) stream.getTracks().forEach(t => t.stop());
  if (audioCtx) audioCtx.close();
  audioCtx = null;
  document.getElementById('noteName').textContent = '-';
  document.getElementById('freqDisplay').textContent = '-- Hz';
  document.getElementById('centsDisplay').textContent = '0 cents';
  document.getElementById('centsDisplay').className = 'cents';
  document.getElementById('indicator').style.left = '50%';
  document.getElementById('indicator').classList.remove('in-tune');
  document.getElementById('guide').textContent = '마이크를 시작하고 기타를 연주하세요';
}

// 기타 특화 피치 감지 (기타 주파수 범위만 검색하는 최적화된 자기상관)
function autoCorrelate(buf, sampleRate) {
  const len = buf.length;

  // RMS 계산
  let rms = 0;
  for (let i = 0; i < len; i++) rms += buf[i] * buf[i];
  rms = Math.sqrt(rms / len);

  // 디버그 표시
  const rmsEl = document.getElementById('rmsVal');
  if (rmsEl) rmsEl.textContent = rms.toFixed(5);

  if (rms < 0.001) {
    const dEl = document.getElementById('detectVal');
    if (dEl) dEl.textContent = `미달 (rms=${rms.toFixed(4)})`;
    return -1;
  }

  // 기타 주파수 범위만 검색: 70Hz(저음) ~ 1400Hz(고음)
  // → lag 범위만 계산해서 O(n²) 대신 O(n * 범위) 로 대폭 단축
  const minLag = Math.floor(sampleRate / 1400); // ~31 샘플
  const maxLag = Math.floor(sampleRate / 70);   // ~630 샘플
  const searchLen = Math.min(len - maxLag, 4096); // 검색 창 4096으로 제한

  if (searchLen < 512) return -1;

  let bestLag = -1;
  let bestCorr = -Infinity;

  for (let lag = minLag; lag <= maxLag; lag++) {
    let corr = 0;
    for (let i = 0; i < searchLen; i++) {
      corr += buf[i] * buf[i + lag];
    }
    // 길이로 정규화
    corr /= searchLen;
    if (corr > bestCorr) {
      bestCorr = corr;
      bestLag = lag;
    }
  }

  // 상관값이 너무 낮으면 무시 (잡음 필터)
  if (bestLag === -1 || bestCorr < rms * rms * 0.1) {
    const dEl = document.getElementById('detectVal');
    if (dEl) dEl.textContent = `상관값 미달`;
    return -1;
  }

  // 포물선 보간으로 정밀도 향상
  const prev = bestLag > minLag ? bestLag - 1 : bestLag;
  const next = bestLag < maxLag ? bestLag + 1 : bestLag;
  let c0 = 0, c1 = 0, c2 = 0;
  for (let i = 0; i < searchLen; i++) {
    c0 += buf[i] * buf[i + prev];
    c1 += buf[i] * buf[i + bestLag];
    c2 += buf[i] * buf[i + next];
  }
  c0 /= searchLen; c1 /= searchLen; c2 /= searchLen;

  const a = (c0 + c2 - 2 * c1) / 2;
  const b = (c2 - c0) / 2;
  const refinedLag = a !== 0 ? bestLag - b / (2 * a) : bestLag;

  return sampleRate / refinedLag;
}

// 주파수 → 가장 가까운 음이름 + 옥타브
function freqToNote(freq) {
  const semitone = 12 * Math.log2(freq / 440);
  const midi = Math.round(semitone) + 69;
  const name = NOTE_NAMES[midi % 12];
  const octave = Math.floor(midi / 12) - 1;
  const exactFreq = 440 * Math.pow(2, (midi - 69) / 12);
  const cents = 1200 * Math.log2(freq / exactFreq);
  return { name, octave, midi, exactFreq, cents };
}

// 가장 가까운 기타 줄 찾기
function findClosestString(freq) {
  let minDist = Infinity, closest = 0;
  GUITAR_STRINGS.forEach((s, i) => {
    const dist = Math.abs(1200 * Math.log2(freq / s.freq));
    if (dist < minDist) { minDist = dist; closest = i; }
  });
  return closest;
}

function detect() {
  if (!isRunning) return;
  animFrameId = requestAnimationFrame(detect);

  const buf = new Float32Array(analyser.fftSize);
  analyser.getFloatTimeDomainData(buf);

  const freq = autoCorrelate(buf, audioCtx.sampleRate);
  if (freq === -1) return; // 소리 없음 (RMS 미달)
  const dEl = document.getElementById('detectVal');
  if (dEl) dEl.textContent = `${freq.toFixed(1)} Hz`;

  const noteInfo = freqToNote(freq);
  const cents = noteInfo.cents;

  // 타겟 줄 결정
  let targetIdx = selectedString;
  if (targetIdx === null) {
    targetIdx = findClosestString(freq);
  }
  const target = GUITAR_STRINGS[targetIdx];
  const centsFromTarget = 1200 * Math.log2(freq / target.freq);

  // UI 업데이트
  const noteEl = document.getElementById('noteName');
  const freqEl = document.getElementById('freqDisplay');
  const centsEl = document.getElementById('centsDisplay');
  const indicator = document.getElementById('indicator');
  const guideEl = document.getElementById('guide');

  noteEl.textContent = noteInfo.name + noteInfo.octave;
  freqEl.textContent = freq.toFixed(1) + ' Hz';

  // 센트 표시 (타겟 기준)
  const absCents = Math.abs(centsFromTarget);
  const roundCents = Math.round(centsFromTarget);

  if (absCents <= 5) {
    centsEl.textContent = '정확!';
    centsEl.className = 'cents in-tune';
    indicator.classList.add('in-tune');
    guideEl.textContent = `${target.note} 정확합니다!`;
    noteEl.style.color = '#44cc66';
  } else {
    indicator.classList.remove('in-tune');
    noteEl.style.color = '#eee';
    if (centsFromTarget > 0) {
      centsEl.textContent = `+${roundCents} cents (높음)`;
      centsEl.className = 'cents sharp';
      guideEl.textContent = `줄을 풀어주세요 ← ${target.note} 목표`;
    } else {
      centsEl.textContent = `${roundCents} cents (낮음)`;
      centsEl.className = 'cents flat';
      guideEl.textContent = `줄을 조여주세요 → ${target.note} 목표`;
    }
  }

  // 미터 인디케이터 위치 (±50센트 범위)
  const clampedCents = Math.max(-50, Math.min(50, centsFromTarget));
  const pct = 50 + (clampedCents / 50) * 45;
  indicator.style.left = pct + '%';
}
</script>
</body>
</html>
