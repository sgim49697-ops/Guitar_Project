<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê¸°íƒ€ íŠœë„ˆ - ë””ìŠ¤í”Œë ˆì´ (ì»´í“¨í„°)</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #1a1a2e;
    color: #eee;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  .container {
    text-align: center;
    width: 500px;
    max-width: 95vw;
  }
  h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: #8888cc;
  }
  .subtitle {
    font-size: 1rem;
    color: #666;
    margin-bottom: 2rem;
  }

  .status {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 2rem;
    font-size: 1rem;
  }
  .status.connected {
    background: #2a4a2a;
    color: #44cc66;
  }
  .status.disconnected {
    background: #4a2a2a;
    color: #cc4444;
  }
  .status.waiting {
    background: #4a4a2a;
    color: #cccc44;
  }

  /* ì¤„ ì„ íƒ í‘œì‹œ */
  .strings {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 2.5rem;
  }
  .strings .string {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid #555;
    background: #2a2a4a;
    color: #ccc;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }
  .strings .string.active {
    border-color: #6a6aff;
    background: #3a3a6a;
    color: #fff;
    transform: scale(1.15);
  }
  .strings .string .note { font-weight: bold; font-size: 1.2rem; }
  .strings .string .num { font-size: 0.75rem; opacity: 0.6; }

  /* ê°ì§€ëœ ìŒ */
  .detected {
    margin-bottom: 2rem;
  }
  .detected .note {
    font-size: 6rem;
    font-weight: bold;
    line-height: 1;
    transition: color 0.3s;
  }
  .detected .freq {
    font-size: 1.3rem;
    color: #888;
    margin-top: 8px;
  }

  /* íŠœë‹ ë¯¸í„° */
  .meter {
    position: relative;
    height: 50px;
    background: #2a2a4a;
    border-radius: 25px;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }
  .meter .center-line {
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 3px;
    background: #666;
    transform: translateX(-50%);
  }
  .meter .indicator {
    position: absolute;
    top: 50%;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #cc4444;
    transform: translate(-50%, -50%);
    transition: left 0.15s, background 0.3s;
    left: 50%;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
  }
  .meter .indicator.in-tune {
    background: #44cc66;
    box-shadow: 0 0 20px #44cc66;
  }

  /* ì„¼íŠ¸ í‘œì‹œ */
  .cents {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    font-weight: bold;
  }
  .cents.sharp { color: #cc6644; }
  .cents.flat { color: #4488cc; }
  .cents.in-tune { color: #44cc66; }

  /* ê°€ì´ë“œ ë©”ì‹œì§€ */
  .guide {
    font-size: 1.3rem;
    min-height: 2em;
    color: #aaa;
  }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ¸ ê¸°íƒ€ íŠœë„ˆ ë””ìŠ¤í”Œë ˆì´</h1>
  <div class="subtitle">ì»´í“¨í„° ëª¨ë‹ˆí„°ìš©</div>

  <div class="status disconnected" id="status">ì„œë²„ ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

  <div class="strings" id="strings"></div>

  <div class="detected">
    <div class="note" id="noteName">-</div>
    <div class="freq" id="freqDisplay">-- Hz</div>
  </div>

  <div class="meter">
    <div class="center-line"></div>
    <div class="indicator" id="indicator"></div>
  </div>

  <div class="cents" id="centsDisplay">0 cents</div>
  <div class="guide" id="guide">iPhoneì—ì„œ ë§ˆì´í¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
</div>

<script>
// ê¸°íƒ€ í‘œì¤€ íŠœë‹
const GUITAR_STRINGS = [
  { num: 6, note: 'E2', freq: 82.41 },
  { num: 5, note: 'A2', freq: 110.00 },
  { num: 4, note: 'D3', freq: 146.83 },
  { num: 3, note: 'G3', freq: 196.00 },
  { num: 2, note: 'B3', freq: 246.94 },
  { num: 1, note: 'E4', freq: 329.63 },
];

// ì¤„ ì„ íƒ ë²„íŠ¼ ìƒì„±
const stringsEl = document.getElementById('strings');
GUITAR_STRINGS.forEach((s) => {
  const div = document.createElement('div');
  div.className = 'string';
  div.innerHTML = `<div class="note">${s.note.replace(/\d/, '')}</div><div class="num">${s.num}ë²ˆ</div>`;
  stringsEl.appendChild(div);
});

// WebSocket ì—°ê²°
let ws = null;
let wsReconnectTimer = null;

function connectWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const host = window.location.host;
  ws = new WebSocket(`${protocol}//${host}`);

  ws.onopen = () => {
    console.log('WebSocket ì—°ê²°ë¨');
    document.getElementById('status').textContent = 'âœ“ ì„œë²„ ì—°ê²°ë¨ - iPhone ì…ë ¥ ëŒ€ê¸° ì¤‘...';
    document.getElementById('status').className = 'status waiting';

    // ë””ìŠ¤í”Œë ˆì´ í´ë¼ì´ì–¸íŠ¸ë¡œ ë“±ë¡
    ws.send(JSON.stringify({ type: 'register', role: 'display' }));
  };

  ws.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);

      if (data.type === 'tuning') {
        updateDisplay(data);
      }
    } catch (e) {
      console.error('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
    }
  };

  ws.onclose = () => {
    console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
    document.getElementById('status').textContent = 'âœ— ì„œë²„ ì—°ê²° ëŠê¹€ - ì¬ì—°ê²° ì‹œë„ ì¤‘...';
    document.getElementById('status').className = 'status disconnected';

    // 3ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„
    wsReconnectTimer = setTimeout(connectWebSocket, 3000);
  };

  ws.onerror = (error) => {
    console.error('WebSocket ì˜¤ë¥˜:', error);
  };
}

connectWebSocket();

function updateDisplay(data) {
  // ì„œë²„ ìƒíƒœ ì—…ë°ì´íŠ¸
  document.getElementById('status').textContent = 'âœ“ iPhone ì—°ê²°ë¨ - ë°ì´í„° ìˆ˜ì‹  ì¤‘';
  document.getElementById('status').className = 'status connected';

  // ê°ì§€ëœ ìŒ í‘œì‹œ
  const noteEl = document.getElementById('noteName');
  const freqEl = document.getElementById('freqDisplay');
  const centsEl = document.getElementById('centsDisplay');
  const indicator = document.getElementById('indicator');
  const guideEl = document.getElementById('guide');

  noteEl.textContent = data.note;
  freqEl.textContent = data.freq.toFixed(1) + ' Hz';

  // íƒ€ê²Ÿ ì¤„ í•˜ì´ë¼ì´íŠ¸
  document.querySelectorAll('.strings .string').forEach((el, i) => {
    el.classList.toggle('active', i === data.targetIdx);
  });

  const absCents = Math.abs(data.cents);
  const roundCents = Math.round(data.cents);

  if (absCents <= 5) {
    centsEl.textContent = 'ì •í™•!';
    centsEl.className = 'cents in-tune';
    indicator.classList.add('in-tune');
    guideEl.textContent = `${data.targetNote} ì •í™•í•©ë‹ˆë‹¤!`;
    noteEl.style.color = '#44cc66';
  } else {
    indicator.classList.remove('in-tune');
    noteEl.style.color = '#eee';
    if (data.cents > 0) {
      centsEl.textContent = `+${roundCents} cents (ë†’ìŒ)`;
      centsEl.className = 'cents sharp';
      guideEl.textContent = `ì¤„ì„ í’€ì–´ì£¼ì„¸ìš” â† ${data.targetNote} ëª©í‘œ`;
    } else {
      centsEl.textContent = `${roundCents} cents (ë‚®ìŒ)`;
      centsEl.className = 'cents flat';
      guideEl.textContent = `ì¤„ì„ ì¡°ì—¬ì£¼ì„¸ìš” â†’ ${data.targetNote} ëª©í‘œ`;
    }
  }

  // ë¯¸í„° ì¸ë””ì¼€ì´í„° ìœ„ì¹˜
  const clampedCents = Math.max(-50, Math.min(50, data.cents));
  const pct = 50 + (clampedCents / 50) * 45;
  indicator.style.left = pct + '%';
}
</script>
</body>
</html>
